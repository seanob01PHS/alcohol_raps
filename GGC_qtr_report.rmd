---
title: "GGC_qtr_report.rmd"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(knitr)
library(lubridate)
library(reactable)
library(sparkline)
library(phsstyles)
library(plotly)


data_dir <- "/conf/LIST_analytics/Glasgow City/Drugs & Alcohol/Alcohol/EASR/output/"
data <- read_csv(paste0(data_dir, "Qtr_alc_adm_GGC.csv")) %>% 
  select(-lookup) %>% 
  mutate(date_end = ymd(date_end),
         EASR=round(EASR, 2))
  

source("trend_table.R")
```

# Landing Page

# Tables

## row {.tabset}

### Alcohol Related Hospital Attendances
```{r reactable_1}
trend_table_data_1 <- trend_table_data(data, "number")

trend_table_data_1_t <- trend_table_data_1 %>%
  pivot_longer(-area, names_to = "year_ending") %>% 
  pivot_wider(names_from = area, values_from = value)

year_end_group <- names(trend_table_data_1) %>% tail(-1)

trend_table_data_1 <- trend_table_data_1 %>% 
  mutate(sparkline=NA)

reactable(trend_table_data_1, columns = list(
  area = colDef(sticky="left", name = "Area", width = 200),
  sparkline = colDef(name = "Trend Lines",
                     sticky = "right",
                     cell = function(value, index) {
    sparkline(trend_table_data_1_t[[trend_table_data_1[[index,1]]]])
  })
  ),
  columnGroups = list(
    colGroup(name="Year Ending", columns=year_end_group)
  )
  )

```



## row

### EASR Trends in detail

```{r trends, show=FALSE}
colours <- c("purple",
             "magenta",
             "blue",
             "green",
             "graphite",
             "teal",
             "liberty",
             "rust")

colours <- phs_colours(sprintf("phs-%s", colours))

big_areas <- c("Scotland", "NHS Greater Glasgow and Clyde")
trend_data <- data %>%
  select(area, date_end, EASR) %>%
  arrange(area %in% big_areas, area) %>%
  rename(Area=area) %>% 
  pivot_wider(names_from = "Area", values_from = "EASR")

min_y <- trend_data %>% select(-date_end) %>% min()
max_y <- trend_data %>% select(-date_end) %>% max()
y_lower <- min_y - 0.1*(max_y-min_y)
y_upper <- max_y + 0.1*(max_y-min_y)

area_names <- trend_data %>% names() %>% tail(-1)
fig <- trend_data %>% 
  plot_ly(type = 'scatter', mode = 'lines',
          line=list(width=3.5)) %>% 
  layout(title = '',
         xaxis = list(title = ''),
         yaxis = list (title = 'EASR (per 100,000)',
                       range = c(y_lower, y_upper)),
         hovermode = "x unified")


for (i in seq_along(area_names)){
  area <- area_names[[i]]
  trace_f <- as.formula(paste0("~`", area, "`"))
  if(area %in% big_areas){
    fig <- fig %>% add_trace(x=~date_end, y=trace_f, name=area, line=list(dash = 'dash', color=colours[[i]]))
  }else{
    fig <- fig %>% add_trace(x=~date_end, y=trace_f, name=area, visible="legendonly", line=list(color=colours[[i]]))  
  }

}
fig

```


# Change Trends

## row {.tabset}

### Attendance Changes

