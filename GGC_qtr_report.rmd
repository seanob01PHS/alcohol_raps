---
title: "GGC_qtr_report.rmd"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(knitr)
library(lubridate)
library(reactable)
library(sparkline)
library(phsstyles)
library(plotly)


data_dir <- "/conf/LIST_analytics/Glasgow City/Drugs & Alcohol/Alcohol/EASR/output/"
data <- read_csv(paste0(data_dir, "Qtr_alc_adm_GGC.csv")) %>% 
  select(-lookup) %>% 
  mutate(date_end = ymd(date_end),
         EASR=round(EASR, 2))
  

source("trend_table.R")
source("table_output.R")
```

# Landing Page

# Attendance Trends

Info {.sidebar}
-------------------------------------

- This page shows alcohol related hospital attendances and EASRs (European Age Standardised Rates) of alcohol related attendances for the HSCPs of NHS Greater Glasgow and Clyde.

- Select the tabs to the right to change from a table showing raw number and EASR.

- The trend lines show a trend for that row and the plot below shows the EASR trends in more detail. Click on the traces in the legend of the plot to show/hide them.


## row {.tabset}

### Alcohol Related Hospital Attendances
```{r reactable_1}
trend_table_data_1 <- trend_table_data(data, "number")
table_with_sparklines(trend_table_data_1)

```

### Alcohol Attendances EASR

```{r reactable_2}
trend_table_data_2 <- trend_table_data(data, "EASR")
table_with_sparklines(trend_table_data_2)

```

## row

### EASR Trends in detail {data-height=650}

```{r trends, show=FALSE}
colours <- c("purple",
             "magenta",
             "blue",
             "green",
             "graphite",
             "teal",
             "liberty",
             "rust")

colours <- phs_colours(sprintf("phs-%s", colours))

big_areas <- c("Scotland", "NHS Greater Glasgow and Clyde")
trend_data <- data %>%
  select(area, date_end, EASR) %>%
  arrange(area %in% big_areas, area) %>%
  rename(Area=area) %>% 
  pivot_wider(names_from = "Area", values_from = "EASR")

min_y <- trend_data %>% select(-date_end) %>% min()
max_y <- trend_data %>% select(-date_end) %>% max()
y_lower <- min_y - 0.1*(max_y-min_y)
y_upper <- max_y + 0.1*(max_y-min_y)

area_names <- trend_data %>% names() %>% tail(-1)
fig <- trend_data %>% 
  plot_ly(type = 'scatter', mode = 'lines',
          line=list(width=3.5)) %>% 
  layout(title = '',
         xaxis = list(title = ''),
         yaxis = list (title = 'EASR (per 100,000)',
                       range = c(y_lower, y_upper)),
         hovermode = "x unified")


for (i in seq_along(area_names)){
  area <- area_names[[i]]
  trace_f <- as.formula(paste0("~`", area, "`"))
  if(area %in% big_areas){
    fig <- fig %>% add_trace(x=~date_end, y=trace_f, name=area, line=list(dash = 'dash', color=colours[[i]]))
  }else{
    fig <- fig %>% add_trace(x=~date_end, y=trace_f, name=area, visible="legendonly", line=list(color=colours[[i]]))  
  }

}
fig

```


# Change Trends

Info {.sidebar}
-------------------------------------

- This page contains tables showing the change in alcohol related attendances.

- Green cells indicate a decrease and red cells an inrease.

- The plots at the top of the page show change relative to the first date shown and the plots at the bottom of the page show year on year change.

- Choosing between the tabs will change whether the underlying figures relate to the raw number of attandences or the EASR.

## row {.tabset}

### Attendance relative to first year

```{r reactable_3}
change_table_data_1 <- relative_change_table_data(data, "number")
table_with_sparklines(change_table_data_1, p_m_colouring = TRUE)
```

### EASR relative to first year

```{r reactable_4}
change_table_data_2 <- relative_change_table_data(data, "EASR")
table_with_sparklines(change_table_data_2, p_m_colouring = TRUE)
```


## row {.tabset}

### Attendance year on year change

```{r reactable_5}
change_table_data_3 <- year_on_year_change(data, "number")
table_with_sparklines(change_table_data_3, p_m_colouring = TRUE)
```

### EASR year on year change

```{r reactable_6}
change_table_data_4 <- year_on_year_change(data, "EASR")
table_with_sparklines(change_table_data_4, p_m_colouring = TRUE)
```
