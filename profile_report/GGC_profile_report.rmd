---
title: "GGC_profile_report"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    css: www/css_styles.css
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(openxlsx)
library(tidyverse)
library(knitr)
library(reactable)
library(sparklines)
library(phsstyles)
library(plotly)
library(stringr)
library(crosstalk)
library(DT)
library(sjmisc)
```

```{r init, include=FALSE}
source("process_wrangle.R")
source("table_output_profile.R")

data_dir <- "/conf/LIST_analytics/Glasgow City/Drugs & Alcohol/Alcohol/output/"
data <-  read.xlsx(paste0(data_dir, "GGC Alcohol Data.xlsx"), 1) %>% 
  select(-lookup)


data <- data %>% process_year()
#selecting the rows in the right order
data <- data[c("iz", "iz_name", "year_start", "year_str", "hscp", "indicator", "pop", "number", "rate")]

big_areas <- c("Scotland", "NHS Greater Glasgow and Clyde", "NHS GGC")
```


# Profile


```{r crosstalk_filter}
all_table_data <- make_profile_frame(data) %>% arrange(desc(across(contains("hospital admissions"))))

```


## row {.tabset}

### Profile Notes

- This table in the **Profile Display** tab shows information at interzone level for various alcohol related harms indicators.
    (@) **Alcohol Specific Deaths:** the time periods for this indicator are 3 calendar year aggregates.
    (@) **Alcohol-related mental health admissions:** the time periods for this indicator are 3 financial year aggregates.
    (@) **Alcohol-related hospital admissions:** the time periods for this indicator are single financial years.  

<br/>

- Use the search bar in the top right of the search bars above the three leftmost columns to filter the data.
- Click on the column headers to sort by that column ascending and again to sort descending.
- Click on the black triangle at the start of each row to display more details including
    - Comparisons in rates relative to Scotland and NHS GGC.
    - The most recent population of that intermediate zone.  

<br/>

- Select a row using the tick-boxes on the left to add it to the rows for which you would like to download the displayed data.
- Change to the **Profile Download** tab to show all the rows that are to be downloaded and click on your selected format to start the download.
- The download data is in a wide format where the additional details are new columns in the data. 



### Profile Display

```{r reactable_display_profile}
download_table <- table_for_download(all_table_data)

shared_table_main <- SharedData$new(all_table_data, group="profile_table", key = ~iz)
shared_table_download <- SharedData$new(download_table, group="profile_table", key = ~iz)

profile_table(all_table_data, shared_table_main)

```

### Profile Download

```{r dt_download_profile}
datatable(shared_table_download,
          height=0.5,
          rownames = FALSE,
          extensions = 'Buttons',
          class = "diaply",
          options=list(dom = 'Bfrtip',
                        buttons = c('copy', 'csv', 'excel')))

```
