---
title: "GGC Alcohol Harms Report"
output: 
  flexdashboard::flex_dashboard:
    logo: ../phs_logo_mono.png
    orientation: rows
    vertical_layout: fill
    css: www/css_styles.css
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(openxlsx)
library(tidyverse)
library(knitr)
library(reactable)
library(sparklines)
library(phsstyles)
library(plotly)
library(stringr)
library(crosstalk)
library(DT)
library(sjmisc)
```

```{r init, include=FALSE}
source("process_wrangle.R")
source("table_output_profile.R")

data_dir <- "/conf/LIST_analytics/Glasgow City/Drugs & Alcohol/Alcohol/output/"
data <-  read.xlsx(paste0(data_dir, "GGC Alcohol Data.xlsx"), 1) %>% 
  select(-lookup)


data <- data %>% process_year()
#selecting the rows in the right order
data <- data[c("iz", "iz_name", "year_start", "year_str", "hscp", "indicator", "pop", "number", "rate")]

big_areas <- c("Scotland", "NHS Greater Glasgow and Clyde", "NHS GGC")
```

# Notes
## row

- This table in the **Profile Display** tab shows information at interzone level for various alcohol related harms indicators.
    (@) **Alcohol Specific Deaths:** the time periods for this indicator are 3 calendar year aggregates.
    (@) **Alcohol-related mental health admissions:** the time periods for this indicator are 3 financial year aggregates.
    (@) **Alcohol-related hospital admissions:** the time periods for this indicator are single financial years.  

<br/>

# Profile


```{r crosstalk_filter}
all_table_data <- make_profile_frame(data) %>% arrange(desc(across(contains("hospital admissions"))))

```


## row {.tabset}

### Profile Notes

- Use the HSCP selector at the top or the search bars above the two leftmost columns to filter the data. Note that selecting **(All)** in the HSCP selector does not function as it should. To return to the unfiltered view, delete anything in the filter box using backspace.
- Click on the column headers to sort by that column ascending and again to sort descending.

 \ 

- The value columns are coloured based on the relative values in that column:
    + <span class="larger_smaller_nums" style="background-color: #EAC43A">larger numbers</span> 
    + <span class="larger_smaller_nums" style="background-color: #FBF4DA">smaller numbers</span>
- The rate of change columns are coloured based on the relative positive (+ve) or negative (-ve) values in that column:
    + <span class="larger_smaller_nums" style="background-color: #d26146">large +ve change</span> 
    + <span class="larger_smaller_nums" style="background-color: #EFC6BD">small +ve change</span>
    + <span class="larger_smaller_nums" style="background-color: #DBECC1">small -ve change</span> 
    + <span class="larger_smaller_nums" style="background-color: #9CC951">large -ve change</span>
    + The rate of change columns also have arrows \ \ 
<span style="color: #B8100D"> `r shiny::icon("arrow-up")` </span> \ 
<span style="color: #71B109"> `r shiny::icon("arrow-down")` </span> \  
<span style="color: #F4E61F"> `r shiny::icon("grip-lines")` </span> \ \ 
corresponding to +ve, -ve and zero change.
    + A dash -- in the rate of change column indicates that the previous value was zero so no relative change can be calculated. 

\ 

- In the initial view there will be red circles \ <span style="color: #B8100D"> `r shiny::icon("circle")` </span> \ that signify if that value is in the 75^th^ percentile or above for NHS GGC.
- Once the data is filtered, an open red circle \ <span style="color: #B8100D"> `r shiny::icon("circle-o")` </span> \ will also be shown to signify if that value is in the 75^th^ percentile or above for the filtered data. If you filter for a specific HSCP this will help identify outliers within that HSCP.

\ 

- Click on the black triangle at the start of each row to display more details
    - Comparisons in rates relative to Scotland and NHS GGC. The cells for this are coloured to the same scheme as the rate of change columns.
    - The most recent population of that intermediate zone.  

\ 


- Select a row using the tick-boxes on the left to add it to the rows for which you would like to download the displayed data.
- Change to the **Profile Download** tab to show all the rows that are to be downloaded and click on your selected format to start the download.
- The download data is in a wide format where the additional details are new columns in the data. 



### Profile Display

```{r reactable_display_profile}
download_table <- table_for_download(all_table_data)

shared_table_main <- SharedData$new(all_table_data, group="profile_table", key = ~iz)
shared_table_download <- SharedData$new(download_table, group="profile_table", key = ~iz)

filter_select("auto", "HSCP", shared_table_main, ~hscp, multiple=FALSE)
profile_table(all_table_data, shared_table_main)

```

### Profile Download

```{r dt_download_profile}
datatable(shared_table_download,
          height=0.5,
          rownames = FALSE,
          extensions = 'Buttons',
          class = "diaply",
          options=list(dom = 'Bfrtip',
                        buttons = c('copy', 'csv', 'excel')))

```
